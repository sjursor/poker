<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PokerCave</title>

    <!-- update the version number as needed -->
    
    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-auth.js"></script>

    <script type="application/javascript" src="/bundle.js"></script>
    <script type="application/javascript" src="/auth.js"></script>
    <script type="application/javascript" src="/jQuery_3.4.1.min.js"></script>
    <script type="application/javascript" src="/players.js"></script>
    <script type="application/javascript" src="/rooms.js"></script>
    <script type="application/javascript" src="/clickHandlers.js"></script>
    <script type="application/javascript" src="/betting.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@200;400;700;900&display=swap" rel="stylesheet"> 
    <link rel="stylesheet" type="text/css" href="cardStyling.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    
  </head>
  <body>
  <div id="userinfowrapper">
    <div id="topmenu">
      <div id="logo"><img src="imgs/pokercave2.png" /></div>
      <div class="userinfo">
        <span id="userinfoname"></span>
        <a id="logout" style="display:none">Logg ut</a>
      </div>
    </div>
  </div>
    <div id="container">
      <div id="loginContainer">
        <button id="login">Logg inn</button>
      </div>
      <div id="game">
        <div id="userControls">
          <button id="fold">Fold</button>
          <button id="showcards">Show cards</button>
          <button id="check">Check</button><button id="bet">Bet</button>
        </div>
        <div id="seats">
          <div class="seatrow" id="row1">
            <div class="player" id="player10">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
                <div class="descr"></div>
                <div class="infotext"></div>
              </div>
            </div>
            <div class="player" id="player1">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
                <div class="descr"></div>
                <div class="infotext"></div>
              </div>
            </div>
            <div id="userCards" class="userfunction">
              <div class="mycards">MY CARDS</div>
              <div class="card" id="userCard1"></div>
              <div class="card" id="userCard2"></div>
              <div class="" id="myCardCurrentStatus"></div>
            </div>
            <div class="player" id="player2">
              <div class="name">&nbsp;</div>
              <div class="wallet"></div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
                <div class="descr"></div>
                <div class="infotext"></div>
              </div>
            </div>
            <div class="player" id="player3">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
                <div class="descr"></div>
                <div class="infotext"></div>
              </div>
            </div>
          </div>
          <div class="seatrow" id="row2">
            <div class="player" id="player9">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
                <div class="descr"></div>
                <div class="infotext"></div>
              </div>
            </div>
            <div class="player" id="player4">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
                <div class="descr"></div>
                <div class="infotext"></div>
              </div>
            </div>
          </div>
          <div class="seatrow" id="row3">
            <div class="player" id="player8">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
                <div class="descr"></div>
                <div class="infotext"></div>
              </div>
            </div>
            <div class="player" id="player7">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
                <div class="descr"></div>
                <div class="infotext"></div>
              </div>
            </div>
            <div class="player" id="player6">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
                <div class="descr"></div>
                <div class="infotext"></div>
              </div>
            </div>
            <div class="player" id="player5">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
                <div class="descr"></div>
                <div class="infotext"></div>
              </div>
            </div>
          </div>
          <div id="currentTable">
            <div class="desk"><img src="imgs/desk/desk_7.png" width="70px"></div>
            <div class="chip"><img src="imgs/chips/gold-1.png" width="30px" style="left: 170px;position: absolute;top: 45px;"></div>
            <div class="chip"><img src="imgs/chips/gold-1.png" width="30px" style="left: 180px;position: absolute;top: 55px;"></div>
            <div class="chip"><img src="imgs/chips/gold-1.png" width="30px" style="left: 186px;position: absolute;top: 38px;"></div>
            <h3>Current Table: <span id="currentTableName"></span></h3>
            <div class="duken" id="duken">

            </div>
            <button id="nextCard">Deal new hand</button>
          </div>
        </div>
    </div>

    <script>
      
    showGame = function(user){
        $("#game").show();
        jQuery("#userinfoname").text("User: "+user.displayName);
        $("#logout").show();
        $("#login").hide();
        
      }

      $(document).ready(function(){
        let app = firebase.app();
        currentRoom   = "";
        currentPlayer = "";
        photoURLs = {};
        
        loginHandler();

        // Table states:
        // 0: No cards dealt (only when initializing new table)
        // 1: Cards dealt to players, no cards on table (this is also first state after previous hand finishes)
        // 2: Flop
        // 3: Turn
        // 4: River
        tableState = 0;

        


          currentRoom = "-M3NcGg4RPa6ShpXgZXa";
          currentDealer = "";

          resetTableCards();

          //List players around Table
          listPlayersAroundTable();

          // Listen for changes to current room
          setTimeout(function() {
            activeRoom = firebase.database().ref('rooms/'+currentRoom);
            activeRoom.on('value', function(snapshot) {
              var val = snapshot.val();

              $("#currentTableName").html(val["name"]);

              // Set tablestate and button text
              if (val["flop"] == "") {
                tableState = 1;
                $("#nextCard").html("Show flop");
              } else if (val["turn"] == "") {
                tableState = 2;
                $("#nextCard").html("Show turn");
              } else if (val["river"] == "") {
                tableState = 3;
                $("#nextCard").html("Show river");
              } else {
                tableState = 4;
                $("#nextCard").html("End game and deal new hand");
              }

              // Show button only when currentplayer is dealer
              currentDealer = val["currentDealer"];
              if (currentDealer != currentPlayer) {$("#nextCard").hide();
              } else {$("#nextCard").show();}

              // Show the flop if available
              if(!val["flop"] || val["flop"] === ""){
                jQuery(".flop span").removeClass();
              } else {
                flop = val["flop"].split(";");
                jQuery("#flopp1").removeClass().addClass(getCardClass(flop[0].split(",")));
                jQuery("#flopp2").removeClass().addClass(getCardClass(flop[1].split(",")));
                jQuery("#flopp3").removeClass().addClass(getCardClass(flop[2].split(",")));
              }


              // Show the turn if available
              if(!val["turn"] || val["turn"] === "") {
                jQuery("#turn").removeClass();
              } else {
                jQuery("#turn").removeClass().addClass(getCardClass(val["turn"]));
              }

              // Show the river if available
              if(!val["river"] || val["river"] === "") {
                jQuery("#river").removeClass();
              } else {
                jQuery("#river").removeClass().addClass(getCardClass(val["river"]));
              }

              // Show folded if anyone
              if (val["folded"]) {
                folded = val["folded"];

                if(!folded || folded.length == 0){
                  jQuery("#fold").removeAttr("disabled");
                }

                // Clear all infotext before applying folded-state
                jQuery(".infotext").empty();
                jQuery(".infotext").hide();

                $.each(folded, function(k,v){
                  if (v) {
                    jQuery("[data-pid='"+v['currentPlayer']+"']").addClass("folded");
                    jQuery("[data-pid='"+v['currentPlayer']+"']").find(".infotext").text("FOLDED");
                    jQuery("[data-pid='"+v['currentPlayer']+"']").find(".infotext").show();
                    if (v['currentPlayer'] == currentPlayer) {
                      //$("#fold").attr("disabled","disabled");
                    }
                  }
                });
              } else {
                // Nobody is folded, reset all infotext
                jQuery(".folded").removeClass("folded");
                jQuery(".infotext").empty();
                jQuery(".infotext").hide();
              }

              // Add dealer class
              if (val["currentDealer"]) {
                $.each($(".player"), function(k, v) {
                  if (val["currentDealer"] == $(this).attr("data-pid")) {
                    $(this).find(".name").addClass("dealer");
                  } else {
                    $(this).find(".name").removeClass("dealer");
                  }
                });
              }

              if (val.betting["playerToTalk"]) {
                console.log(val.betting["playerToTalk"]);
                $(".playerToTalk").removeClass("playerToTalk");
                $(".player[data-pid='"+val.betting["playerToTalk"]+"']").addClass("playerToTalk");
              }else{
                console.log("found no player to talk", val);
              }

              //See currentPlayerHandDescription
              currentPlayerHandDescription();

              // Reset photo URLs
              $.each(photoURLs, function(k, v) {
                $("[data-pid='" + k + "'] .playercards").css("background-image", "url(" + photoURLs[k] + ")");
              });


              // Show the cards of those who have decided to show their cards
              shownCards = val["shownCards"];

              $(".playercards").each(function(e, obj) {
                $(this).find(".playercard1").removeClass().addClass("playercard1");
                $(this).find(".playercard2").removeClass().addClass("playercard2");
                $(this).find(".descr").text("").hide();
              });
              $(".winner").removeClass("winner");

              if (shownCards) {
                let rank = [];
                $.each(shownCards,function(k, v) {

                  // Remove profile picture
                  $("[data-pid='" + k + "'] .playercards").css("background-color", "#fff");
                  $("[data-pid='" + k + "'] .playercards").css("background-image", "none");

                  // Get active cards
                  var userCards = shownCards[k].cardClass.split(";");
                  // Show card 1
                  $("[data-pid='" + k + "'] .playercards .playercard1").addClass(userCards[0]);
                  // Show card 2
                  $("[data-pid='" + k + "'] .playercards .playercard2").addClass(userCards[1]);

                  solvShownCards();
                  $("[data-pid='" + k + "'] .playercards .descr").text(shownCards[k].descr).show();

                  //Solving Rank
                  let tableCards = getTableCards();
                  var folded = jQuery("[data-pid='"+k+"']").hasClass("folded");
                  if(!folded){
                    rank.push(Hand.solve(tableCards.concat(shownCards[k].cards)));
                  }

                  //var hand1 = Hand.solve(tableCards);
                  //var hand2 = Hand.solve(['3d', 'As', 'Jc', 'Th', '2d', '4s', 'Qd']);
                  //var winner = Hand.winners([hand1, hand2]); // hand2
                  
                });
                let winner = Hand.winners(rank); // hand2
                console.log(winner);
                console.log(rank);
                //console.log(winner);
                var winPlayer = jQuery(".player .descr:contains("+winner[0].descr+")");
                winPlayer.addClass("winner");
              }

            });
          }, 2000);

        //});

        clickHandlers();

        resetTableCards();
        
        talkingPlayer();

        setTimeout(function(){
          getBetting(players,currentDealer);
        },2500);
            
      });

      getCardClass = function(card, removeDefault){
        if(!card){return;}
        var type = getType(card[0]);
        return (removeDefault == true ? "" : "card ")+card[1].toLowerCase()+'_'+type;
      }

      getType = function(s){
        if(!s){return;}
        r = s
        .replace("♣️","clubs")
        .replace("♠️","spades")
        .replace("❤️","hearts")
        .replace("♦️","diamonds")

        return r;
      }

      resetTableCards = function(){
        $("#duken").html('<div class="flop">\
          <span class="card" id="flopp1"></span>\
          <span class="card" id="flopp2"></span>\
          <span class="card" id="flopp3"></span>\
        </div>\
        <div class="turn">\
          <span class="card" id="turn"></span>\
        </div>\
        <div class="river">\
          <span class="card" id="river"></span>\
        </div>');
      }

      


      

      
    </script>
  </body>
</html>
