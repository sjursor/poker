<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PokerCave</title>

    <!-- update the version number as needed -->
    
    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-auth.js"></script>

    <script type="application/javascript" src="/bundle.js"></script>
    <script type="application/javascript" src="/auth.js"></script>
    <script type="application/javascript" src="/jQuery_3.4.1.min.js"></script>

    <link rel="stylesheet" type="text/css" href="cardStyling.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    
  </head>
  <body>
  <div id="userinfowrapper">
    <div id="userinfo"><span id="userinfoname"></span><a id="logout" style="display:none">Logg ut</a></div>
  </div>

    <div id="container">
      <div id="loginContainer">
        <button id="login">Logg inn</button>
      </div>
      <div id="game">
        <div id="admin">
          <div id="profile">
            <div id="activePlayers">
              <h3>Players</h3>
              <ul></ul>
            </div>
          </div>
        
          <div id="rooming">
           <div id="roomlist">
              <h3>Existing tables</h3>
              <ul></ul>
            </div>
          </div>
        </div>
        <div id="seats">
          <div class="seatrow" id="row1">
            <div class="player" id="player10">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
              </div>
              <div class="infotext"></div>
            </div>
            <div class="player" id="player1">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
              </div>
              <div class="infotext"></div>
            </div>
            <div class="player" id="player2">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
              </div>
              <div class="infotext"></div>
            </div>
            <div class="player" id="player3">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
              </div>
              <div class="infotext"></div>
            </div>
          </div>
          <div class="seatrow" id="row2">
            <div class="player" id="player9">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
              </div>
              <div class="infotext"></div>
            </div>
            <div class="player" id="player4">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
              </div>
              <div class="infotext"></div>
            </div>
          </div>
          <div class="seatrow" id="row3">
            <div class="player" id="player8">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
              </div>
              <div class="infotext"></div>
            </div>
            <div class="player" id="player7">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
              </div>
              <div class="infotext"></div>
            </div>
            <div class="player" id="player6">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
              </div>
              <div class="infotext"></div>
            </div>
            <div class="player" id="player5">
              <div class="name">&nbsp;</div>
              <div class="playercards">
                <div class="playercard1"></div>
                <div class="playercard2"></div>
              </div>
              <div class="infotext"></div>
            </div>
          </div>
          <div id="currentTable">
            <h3>Current Table: <span id="currentTableName"></span></h3>
            <div class="duken" id="duken">

            </div>
            <button id="nextCard">Deal new hand</button>
          </div>
        </div>

        <div id="userfunctions">
          <div id="userCards" class="userfunction">
            <h3>User cards</h3>
            <div class="card" id="userCard1"></div>
            <div class="card" id="userCard2"></div>
          </div>
          <div id="userButtons" class="userfunction">
            <button id="fold">Fold hand</button><br>
            <button id="showcards">Show cards</button>

          </div>
        </div>

      </div>
    </div>

    <script>
      
    showGame = function(user){
        $("#game").show();
        jQuery("#userinfoname").text("User: "+user.displayName);
        $("#logout").show();
        $("#login").hide();
        
      }

      $(document).ready(function(){
        let app = firebase.app();
        currentRoom   = "";
        currentPlayer = "";
        
        loginHandler();

        //Show admin tools if ?admin=true
        let searchParams = new URLSearchParams(window.location.search)
        if(searchParams.has('admin')){$("#admin").show();}

        // Table states:
        // 0: No cards dealt (only when initializing new table)
        // 1: Cards dealt to players, no cards on table (this is also first state after previous hand finishes)
        // 2: Flop
        // 3: Turn
        // 4: River
        tableState = 0;
        

        //var db = firebase.database();
        

        //List current rooms in firebase
        var roomsRef = firebase.database().ref('rooms');
        roomsRef.on('value', function(snapshot) {
          $("#roomlist ul li").remove();
          $.each(snapshot.val(), function(key,roomData){
            var li = $("#roomlist ul").append('<li data-fid="'+key+'" data-name="'+roomData['name']+'">'+roomData['name']+'</li>'); 
          });

            //var name = $(this).data("name");
            //$("#currentTableName").html(name);
            currentRoom = "-M3NcGg4RPa6ShpXgZXa";
            currentDealer = "";
            resetTableCards();


            activeRoom = roomsRef.child(currentRoom);
          activeRoom.on('value', function(snapshot) {
            var val = snapshot.val();
            $("#currentTableName").html(val["name"]);

            if (val["flop"] == "") {
              tableState = 1;
              $("#nextCard").html("Show flop");
            } else if (val["turn"] == "") {
              tableState = 2;
              $("#nextCard").html("Show turn");
            } else if (val["river"] == "") {
              tableState = 3;
              $("#nextCard").html("Show river");
            } else {
              tableState = 4;
              $("#nextCard").html("End game and deal new hand");
            }

            // Show button only when currentplayer is dealer
            currentDealer = val["currentDealer"];
            if (currentDealer != currentPlayer) {$("#nextCard").hide();
            } else {$("#nextCard").show();}


            // Show the cards of those who have decided to show their cards
            shownCards = val["shownCards"];
            $(".playercards").each(function(e, obj) {
              $(this).find(".playercard1").removeClass().addClass("playercard1");
              $(this).find(".playercard2").removeClass().addClass("playercard2");
            });

            setTimeout(function() {
              if (shownCards) {
                $.each(shownCards,function(k, v) {

                  // Remove profile picture
                  $("[data-pid='" + k + "'] .playercards").css("background-color", "#fff");
                  $("[data-pid='" + k + "'] .playercards").css("background-image", "none");

                  // Get active cards
                  var userCards = shownCards[k].cards.split(";");
                  // Show card 1
                  $("[data-pid='" + k + "'] .playercards .playercard1").addClass(userCards[0]);
                  // Show card 2
                  $("[data-pid='" + k + "'] .playercards .playercard2").addClass(userCards[1]);
                });

              }
            },500);

          });

            //List players
            var playersRef = firebase.database().ref('rooms/'+currentRoom+"/players");
            playersRef.on('value', function(snapshot){
              var ex_players = snapshot.val();
              
              //remove empty player-index
              var players = [];
              $.each(ex_players,function(k,player){
                players.push(player);
              });

              $.each(players,function(k,v){

                var playerRef = firebase.database().ref('players/'+v);
                //console.log(playerRef)
                playerRef.once('value', function(snapshot) {
                  var val = snapshot.val();
                  var playerkey = snapshot.key;

                  var playerPos = $.inArray(playerkey,players)+1;

                  if(val !== null) {
                    // Add player pid as a data attribute
                    $("#player" + playerPos).attr("data-pid", playerkey);
                    if(val.photo){
                      $("#player" + playerPos + " .playercards").css("background-image", "url("+val.photo+"?width=135)");
                      $("#player" + playerPos + " .playercards").css("background-size", "contain");
                      //$("#player" + playerPos + " .playercards").html("<div class='infotext'></div>");
                    }else{

                    }
                    // Add dealer class
                    if (playerkey == currentDealer) {
                      $("[data-pid='" + v + "'] .name").addClass("dealer");
                    } else {
                      $("[data-pid='" + v + "'] .name").removeClass("dealer");
                    }

                    // Write the player name
                    $("#player" + playerPos + " .name").html(val["name"]);

                  }

                });
              });
              $( document ).on( "click", "span.removePlayerFromTable", function() {
                var table = $(this).data("table");
                var uid   = $(this).data("uid");
                removePlayerFromTable(uid,table);
              });
            });
            
            var flop = firebase.database().ref('rooms').child(currentRoom).child("flop");
            flop.on('value', function(snapshot) {
              flop = snapshot.val();
                if(!flop){
                  //console.log("no flop");
                  jQuery(".flop span").removeClass();
                } else {
                  flop = flop.split(";");
                  jQuery("#flopp1").removeClass().addClass(getCardClass(flop[0].split(",")));
                  jQuery("#flopp2").removeClass().addClass(getCardClass(flop[1].split(",")));
                  jQuery("#flopp3").removeClass().addClass(getCardClass(flop[2].split(",")));
                }

            });

            var turn = firebase.database().ref('rooms').child(currentRoom).child("turn");
            turn.on('value', function(snapshot) {
              turn = snapshot.val();
                jQuery("#turn").removeClass().addClass(getCardClass(turn));
            });

            var river = firebase.database().ref('rooms').child(currentRoom).child("river");
            river.on('value', function(snapshot) {
              river = snapshot.val();
                jQuery("#river").removeClass().addClass(getCardClass(river));
            });

            var foldedRef = firebase.database().ref('rooms').child(currentRoom).child("folded");
            foldedRef.on('value', function(snapshot) {
              folded = snapshot.val();

              if(!folded || folded.length == 0){
                jQuery("#fold").removeAttr("disabled");
              }
              setTimeout(function(){
                $.each(folded, function(k,v){
                  if (v) {
                    jQuery("[data-pid='"+v['currentPlayer']+"']").find(".infotext").text("FOLDED");
                    if (v['currentPlayer'] == currentPlayer) {
                      $("#fold").attr("disabled","disabled");
                    }
                  }
                })
              },500);



            });



        });


          //Click handlers
          // New room
          $("#newRoomSubmit").click(function(){
              var roomName = jQuery("#roomInput").val();
              createNewRoom(roomName);
          });


          // Next card
          $("#nextCard").click(function() {
            switch (tableState) {
              case 0:
                if (confirm("Deal new hand?")) {
                  setNextDealerAndDealHand();
                  $("#nextCard").html("Show flop");
                  tableState = 1;
                }
                break;

              case 1:
                if (confirm("Show flop?")) {
                  showFlop();
                  $("#nextCard").html("Show turn");
                  tableState = 2;
                }
                break;

              case 2:
                if (confirm("Show turn?")) {
                  showTurn();
                  $("#nextCard").html("Show river");
                  tableState = 3;
                }
                break;

              case 3:
                if (confirm("Show river?")) {
                  showRiver();
                  $("#nextCard").html("End game and deal new hand");
                  tableState = 4;
                }
                break;

              case 4:
                if (confirm("End game and deal new hand?")) {
                  setNextDealerAndDealHand();
                  $("#nextCard").html("Show flop");
                  tableState = 1;
                }
                break;
            }

          });


        // Fold-button
        $("#fold").click(function() {

          if (confirm("Fold hand?")) {
            firebase.database().ref('rooms/'+currentRoom+"/folded").push({
              currentPlayer
            });
            $("#fold").attr("disabled","disabled");
          }
        });


        // Show card-button
        $("#showcards").click(function() {

          if (confirm("Show cards?")) {

            var card1 = $("#userCard1").attr("class").replace("card ", "");
            var card2 = $("#userCard2").attr("class").replace("card ", "");
            cards = card1+";"+card2;

            firebase.database().ref('rooms/'+currentRoom+"/shownCards/"+currentPlayer).set({
              cards
            });
            $("#showCards").attr("disabled","disabled");
          }

        });



        resetTableCards();
            
      });

      getCardClass = function(card, removeDefault){
        if(!card){return;}
        var type = getType(card[0]);
        return (removeDefault == true ? "" : "card ")+card[1].toLowerCase()+'_'+type;
      }

      getType = function(s){
        if(!s){return;}
        r = s
        .replace("♣️","clubs")
        .replace("♠️","spades")
        .replace("❤️","hearts")
        .replace("♦️","diamonds")

        return r;
      }

      resetTableCards = function(){
        $("#duken").html('<div class="flop">\
          <span class="card" id="flopp1"></span>\
          <span class="card" id="flopp2"></span>\
          <span class="card" id="flopp3"></span>\
        </div>\
        <div class="turn">\
          <span class="card" id="turn"></span>\
        </div>\
        <div class="river">\
          <span class="card" id="river"></span>\
        </div>');
      }

      //Create new rooms
      createNewRoom = function(name){
        let roomData = {
          name:name,
          players:0,
          currentDealer:0,
          flop:[],
          turn:"",
          river:""
        };
        let newRoomKey = firebase.database().ref().child('rooms').push().key;
        
        var updates = {};
        updates['/rooms/' + newRoomKey] = roomData;
        firebase.database().ref().update(updates);
        currentRoom = newRoomKey;
        return newRoomKey;
      }

      //Create new player
      newPlayer = function(uid, email, displayName, photoURL, callback){
        let newPlayerKey = firebase.database().ref('players/'+uid);
        createNewPlayer(uid, email, displayName, photoURL,callback);
        callback(uid);
        // newPlayerKey.once("value", function(snapshot){
        //   if(snapshot.val() == null){
        //     createNewPlayer(uid, email, displayName, photoURL,callback);
        //   }else{
        //     currentPlayer = uid;
        //     callback(uid);
        //   }
        // });
      }

      createNewPlayer = function(uid, email, displayName, photoURL,callback){
        firebase.database().ref().child('players/'+uid).set({
          name:displayName,
          email:email,
          photo:photoURL,
          stack:0,
          currentRoom:currentRoom
        },function(error) {
          if (error) {
            console.log("The write failed...");
          } else {
            // Data saved successfully!
            currentPlayer = uid;
            //callback(uid);
          }
        });
      }

      addPlayerToTable = function(player,table){
        var ref = firebase.database().ref('rooms/'+table+'/players');
        ref.once("value", function(snapshot){
          var ex_players = snapshot.val();
          var players = [];
          $.each(ex_players,function(k,p){
            if(p){players.push(p);}
          });

          //Add player to playerslist if not already on table
          if($.inArray(player,players)==-1){players.push(player); }

          //setting currentRoom on player obj
          firebase.database().ref('players/'+player+'/currentRoom').set(table);
          //setting players on table
          firebase.database().ref('rooms/'+table+'/players').set(players);

        });
      }
          
      removePlayerFromTable = function(player,table){
        var ref = firebase.database().ref('rooms/'+table);
        ref.once("value", function(snapshot){
          var data = snapshot.val();
          var players = data['players'];

          console.log(players);
          var newPlayers = [];
          $.each(players,function(k,v){
            console.log(k,v);
            if(v == player){
              return;
            }else{
              newPlayers.push(v);
            }
          });

          var updates = {};
          updates['/rooms/' + table + '/players'] = newPlayers;
          return firebase.database().ref().update(updates);
        });
      }


      updateUserCards = function() {
          playerRef = firebase.database().ref('players/'+currentPlayer);
          playerRef.on('value', function(snapshot){
            var userData = snapshot.val();

            // if (userData['currentRoom'] == table) {
              if(userData['activeCards']){
                var userCards = userData['activeCards'].split(";");
                var klass1 = userCards[0].split(",");
                var type = getType(klass1[0]);
                $("#userCard1").removeClass().addClass(getCardClass(klass1));

                var klass2 = userCards[1].split(",");
                var type = getType(klass2[0]);
                $("#userCard2").removeClass().addClass(getCardClass(klass2));//"card "+klass2[1].toLowerCase()+'_'+type);  
              }
              

            // } else {
            //   $("#userCard1").text("Error: currentTable is not players currentTable");
            //   console.log("User not on current table error");
            //   console.log(userData['currentRoom'], table);
            // }
          });

      }

      
    </script>
  </body>
</html>
