<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PokerCave</title>

    <!-- update the version number as needed -->
    
    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-auth.js"></script>

    <script type="application/javascript" src="/auth.js"></script>
    <script type="application/javascript" src="/bundle.js"></script>
    <!-- include only the Firebase features as you need -->
    

    <script type="application/javascript"
        src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" 
        crossorigin="anonymous"></script>

    <script type="text/javascript">

      const firebaseConfig = {
        apiKey: "AIzaSyDl7d1_BOmwKUCKE22PjSBGagUsXtIy9EU",
        authDomain: "poker-9c76f.firebaseapp.com",
        databaseURL: "https://poker-9c76f.firebaseio.com",
        projectId: "poker-9c76f",
        storageBucket: "poker-9c76f.appspot.com",
        messagingSenderId: "661582615603",
        appId: "1:661582615603:web:bdbbe82e9fd68d265b3f46"
      };

      firebase.initializeApp(firebaseConfig);
    </script>

    <link rel="stylesheet" type="text/css" href="cardStyling.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    
  </head>
  <body>

    
    <div id="container">
      <div id="userinfo"></div> - <div id="logout" style="display:none">Logg ut</div>
      <div id="game">
        <div id="admin">
          <div id="profile">
            <div id="activePlayers">
              <h3>Players</h3>
              <ul></ul>
            </div>
          </div>
        
          <div id="rooming">
           <div id="roomlist">
              <h3>Existing tables</h3>
              <ul></ul>
            </div>
          </div>
        </div>
        <div id="seats">
          <div class="seatrow" id="row1">
            <div class="player" id="player10"><span class="name">&nbsp;</span><div class="playercards"></div></div>
            <div class="player" id="player1"><span class="name">&nbsp;</span><div class="playercards"></div></div>
            <div class="player" id="player2"><span class="name">&nbsp;</span><div class="playercards"></div></div>
            <div class="player" id="player3"><span class="name">&nbsp;</span><div class="playercards"></div></div>
          </div>
          <div class="seatrow" id="row2">
            <div class="player nocards" id="player9"><span class="name">&nbsp;</span><div class="playercards"></div></div>
            <div class="player" id="player4"><span class="name">&nbsp;</span><div class="playercards"></div></div>
          </div>
          <div class="seatrow" id="row3">
            <div class="player" id="player8"><span class="name">&nbsp;</span><div class="playercards"></div></div>
            <div class="player" id="player7"><div class="playercards"></div><span class="name">&nbsp;</span></div>
            <div class="player" id="player6"><div class="playercards"></div><span class="name">&nbsp;</span></div>
            <div class="player" id="player5"><span class="name">&nbsp;</span><div class="playercards"></div></div>
          </div>
          <div id="currentTable">
            <h3>Current Table: <span id="currentTableName"></span></h3>
            <div class="duken" id="duken">

            </div>
            <button id="nextCard">Deal new hand</button>
          </div>
        </div>

        <div id="playersAtTable"><h3>Players at this table</h3><ul></ul></div>

        
        <div id="userCards">
          <h3>User cards</h3>
          <div class="card" id="userCard1"></div>
          <div class="card" id="userCard2"></div>
        </div>

        <div id="admin">
          <h3>Create player</h3>
          <input name="name" id="nameInput" type="text"/>
          <button type="submit" id="profileSubmit">Submit</button>
          
          <h3>Create new room</h3>
          <input name="room" id="roomInput" type="text"/>
          <button type="submit" id="newRoomSubmit">Create new room</button>
        </div>

      </div>
    </div>

    <script>
      
      $(document).ready(function(){
        let app = firebase.app();
        let currentUser;
        currentRoom = "";
        currentPlayer = "";

        
        
        var provider = new firebase.auth.FacebookAuthProvider();

        firebase.auth().signInWithRedirect(provider).then(function(result) {
          // This gives you a Facebook Access Token. You can use it to access the Facebook API.
          var token = result.credential.accessToken;
          // The signed-in user info.
          var user = result.user;

          $("#userinfo").text(result.user.displayName +' - '+result.user.email);
          $("#game").show();

          $("#logout").show();
          $("#logout").on("click", function(){
            firebase.auth().signOut().then(function() {
              console.log("signed out success");
              $("#logout").hide();
              $("#userinfo").text("You must log in to play the game (reload page)");
              $("#game").hide();
            }).catch(function(error) {
              console.log("error", error);
            });
          });
          // ...
        }).catch(function(error) {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
          // The email of the user's account used.
          var email = error.email;
          // The firebase.auth.AuthCredential type that was used.
          var credential = error.credential;
          console.log(errorMessage, errorCode, email);
          // ...
        });



        
        let searchParams = new URLSearchParams(window.location.search)
        if(searchParams.has('admin')){
          $("#admin").show();
        }

        // Table states:
        // 0: No cards dealt (only when initializing new table)
        // 1: Cards dealt to players, no cards on table (this is also first state after previous hand finishes)
        // 2: Flop
        // 3: Turn
        // 4: River
        let tableState = 0;

          //firebase.database().ref('/').on('value', snapshot => { console.log(snapshot) });
          
          //var fs = firebase.firestore();
          var db = firebase.database();



          //List current rooms in firebase
          var roomsRef = firebase.database().ref('rooms');
          roomsRef.on('value', function(snapshot) {
            $("#roomlist ul li").remove();
            $.each(snapshot.val(), function(key,roomData){
              var li = $("#roomlist ul").append('<li data-fid="'+key+'" data-name="'+roomData['name']+'">'+roomData['name']+'</li>'); 
            });
            $("#roomlist ul li").click(function(){
              $("#roomlist ul li.active").removeClass("active");
              $(this).addClass("active");
              var name = $(this).data("name");
              $("#currentTableName").html(name);
              currentRoom = $(this).data('fid');
              resetTableCards();

              //List players
              jQuery("#playersAtTable ul").empty();
              var playersRef = firebase.database().ref('rooms/'+currentRoom+"/players");
              playersRef.on('value', function(snapshot){
                jQuery("#playersAtTable ul").empty();
                var players = snapshot.val();
                var counter = 1;
                $(players).each(function(k,v){
                  var playerRef = firebase.database().ref('players/'+v);
                  playerRef.on('value', function(snapshot) {
                    var val = snapshot.val();
                    var playerkey = snapshot.key;
                    if(val !== null) {
                      // Add player pid as a data attribute
                      $("#player" + counter + " .name").attr("data-pid", playerkey);

                      // Write the player name
                      $("#player" + counter + " .name").html(val["name"]);

                      // Get the current dealer for the room
                      var currentDealerRef = firebase.database().ref('rooms/'+currentRoom+"/currentDealer");
                      currentDealerRef.on('value', function(snapshot) {
                        currentDealer = snapshot.val();

                        // Make sure no players has the dealer class
                        $(".dealer").removeClass("dealer");

                        // Set the dealer class on the correct player
                        $("[data-pid='" + currentDealer + "']").addClass("dealer");
                      });

                      counter++;

                      // TODO: Remove old ul list when not needed anymore
                      jQuery("#playersAtTable ul").append("<li data-attr='"+v+"'>\
                                                              <b>"+val['name']+"</b>\
                                                              ("+val['stack']+")\
                                                              <span class='removePlayerFromTable' data-table="+currentRoom+" data-uid='"+v+"'>\
                                                                Remove from table\
                                                              </span>\
                                                            </li>");
                    }

                    //console.log(val["name"]);

                  });
                });
                $( document ).on( "click", "span.removePlayerFromTable", function() {
                  var table = $(this).data("table");
                  var uid   = $(this).data("uid");
                  removePlayerFromTable(uid,table);
                });
              });
              
              var flop = firebase.database().ref('rooms').child(currentRoom).child("flop");
              flop.on('value', function(snapshot) {
                flop = snapshot.val();
                  if(!flop){
                    console.log("no flop");
                    jQuery(".flop span").removeClass();
                  }else{
                    flop = flop.split(";");
                    console.log("flop: "+flop);
                    jQuery("#flopp1").removeClass().addClass(getCardClass(flop[0].split(",")));
                    jQuery("#flopp2").removeClass().addClass(getCardClass(flop[1].split(",")));
                    jQuery("#flopp3").removeClass().addClass(getCardClass(flop[2].split(",")));
                  }
                  
                
              });

              var turn = firebase.database().ref('rooms').child(currentRoom).child("turn");
              turn.on('value', function(snapshot) {
                turn = snapshot.val();
                  jQuery("#turn").removeClass().addClass(getCardClass(turn));
              });

              var river = firebase.database().ref('rooms').child(currentRoom).child("river");
              river.on('value', function(snapshot) {
                river = snapshot.val();
                  jQuery("#river").removeClass().addClass(getCardClass(river));
              });


            })
            if(!currentRoom){
              jQuery("#roomlist ul li").first().click();
            }
          });

          //List current rooms in firebase
          var usersRef = firebase.database().ref('players');
          usersRef.on('value', function(snapshot) {
            $("#activePlayers ul li").remove();
            $.each(snapshot.val(), function(key,usersData){
              if(usersData['name'])
              var li = $("#activePlayers ul").append('<li>\
                                                        <span class="pname" data-fid="'+key+'">'+usersData['name']+'</span>\
                                                        <span class="addPlayerToTable" data-uid="'+key+'"> - Legg til</span>\
                                                      </li>');

              $("#activePlayers ul li span.pname").click(function(){
                  $("#activePlayers ul li .pname.active").removeClass("active");
                  $(this).addClass("active");
                  var fid = $(this).data("fid");
                  currentUser = fid;
                  currentUserRef = usersRef.child(fid);
                  currentUserRef.on('value', function(snapshot){
                    var userData = snapshot.val();

                    if(userData['currentRoom'] == currentRoom){
                      var userCards = userData['activeCards'].split(";");
                      var klass1 = userCards[0].split(",");
                      var type = getType(klass1[0]);
                      $("#userCard1").removeClass().addClass(getCardClass(klass1));

                      var klass2 = userCards[1].split(",");
                      var type = getType(klass2[0]);
                      $("#userCard2").removeClass().addClass(getCardClass(klass2));//"card "+klass2[1].toLowerCase()+'_'+type);                      
                      
                    }else{
                      console.log("User not on current table error");
                    }
                  });
                  //console.log("setting currentUserTo "+fid);
              });


            });

            //Add user to current table
            $("span.addPlayerToTable").click(function(){
                var uid = $(this).data("uid");
                addPlayerToTable(uid,currentRoom);
                //TODO: Remove from #activePlayers list to prevent users appearing on multiple table
            })
            
            if(!currentPlayer){
              jQuery("#activePlayers ul li").first().click();  
            }
            
            
          });

          //Click handlers
        // New room
          $("#newRoomSubmit").click(function(){
              var roomName = jQuery("#roomInput").val();
              createNewRoom(roomName);
          });

          // New player
          $("#profileSubmit").click(function(){
              var userName = jQuery("#nameInput").val();
              createNewPlayer(userName);
          });

          // Next card
          $("#nextCard").click(function() {
            switch (tableState) {
              case 0:
                setNextDealerAndDealHand();
                $("#nextCard").html("Show flop");
                tableState = 1;
                break;

              case 1:
                showFlop();
                $("#nextCard").html("Show turn");
                tableState = 2;
                break;

              case 2:
                showTurn();
                $("#nextCard").html("Show river");
                tableState = 3;
                break;

              case 3:
                showRiver();
                $("#nextCard").html("End game and deal new hand");
                tableState = 4;
                break;

              case 4:
                setNextDealerAndDealHand();
                $("#nextCard").html("Show flop");
                tableState = 1;
                break;
            }

          });
          getCardClass = function(card){
            if(!card){return;}
            var type = getType(card[0]);
            return "card "+card[1].toLowerCase()+'_'+type;
          }

          getType = function(s){
            if(!s){return;}
            r = s
            .replace("♣️","clubs")
            .replace("♠️","spades")
            .replace("❤️","hearts")
            .replace("♦️","diamonds")

            return r;
          }

          resetTableCards = function(){
            $("#duken").html('<div class="flop">\
              <span class="card" id="flopp1"></span>\
              <span class="card" id="flopp2"></span>\
              <span class="card" id="flopp3"></span>\
            </div>\
            <div class="turn">\
              <span class="card" id="turn"></span>\
            </div>\
            <div class="river">\
              <span class="card" id="river"></span>\
            </div>');
          }

          //Create new rooms
          createNewRoom = function(name){
            let roomData = {
              name:name,
              players:0,
              currentDealer:0,
              flop:[],
              turn:"",
              river:""
            };
            let newRoomKey = firebase.database().ref().child('rooms').push().key;
            
            var updates = {};
            updates['/rooms/' + newRoomKey] = roomData;
            return firebase.database().ref().update(updates);
          }

          //Create new player
          createNewPlayer = function(name){
            let newPlayerKey = firebase.database().ref().child('players').push().key;
            let newPlayerData = {
              name:name,
              stack:0
            }
            var updates = {};
            updates['/players/' + newPlayerKey] = newPlayerData;

            return firebase.database().ref().update(updates);
          }

          addPlayerToTable = function(player,table){
            var ref = firebase.database().ref('rooms/'+table);
            ref.once("value", function(snapshot){
              var data = snapshot.val();
              var players = data['players'];
              if(typeof(players)!=="object"){
                players = [];  
              }
              players.push(player);

              var updates = {};
              updates['/rooms/' + table + '/players'] = players;
              return firebase.database().ref().update(updates);
            });
          }
          removePlayerFromTable = function(player,table){
            var ref = firebase.database().ref('rooms/'+table);
            ref.once("value", function(snapshot){
              var data = snapshot.val();
              var players = data['players'];
              console.log(players);
              var newPlayers = [];
              $.each(players,function(k,v){
                console.log(k,v);
                if(v == player){
                  return;
                }else{
                  newPlayers.push(v);
                }
              });

              var updates = {};
              updates['/rooms/' + table + '/players'] = newPlayers;
              return firebase.database().ref().update(updates);
            });
          }


          resetTableCards();
            
      });

      
    </script>
  </body>
</html>
